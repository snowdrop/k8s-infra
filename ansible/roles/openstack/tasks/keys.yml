- name: "Find controller user home folder"
  local_action: "shell echo {{ lookup('env','HOME') }}"
  register: controller_user_home

# - name: "Set admin ssh key path"
#   set_fact: key_path="{{ controller_user_home.stdout }}/.ssh/id_openstack.rsa"
#   no_log: True


- name: "Set admin ssh key path"
  set_fact: 
    key_path: "{{ controller_user_home.stdout }}/.ssh/id_rsa_snowdrop_openstack_'+vm_name+'/id_openstack"
  no_log: True

# - stat:
#     path: "{{ key_path }}"
#   register: st

# - name: Generate SSH keys
#   shell: ssh-keygen -b 2048 -t rsa -f {{ key_path }} -q -N ""
#   when: st.stat.exists == false

- name: OpenStack params
  debug:
    verbosity: 2
    msg:
      - project_name: "{{ openstack.os_project_name }}"
      - username: "{{ openstack.os_username }}"
      # - password: "{{ openstack.os_password }}"
      - auth_url: "{{ openstack.os_auth_url }}"

- name: Create SSH key to use with instance {{ openstack.vm.name }}
  os_keypair:
    state: present
    auth:
      project_name: "{{ openstack.os_project_name }}"
      username: "{{ openstack.os_username }}"
      password: "{{ openstack.os_password }}"
      auth_url: "{{ openstack.os_auth_url }}"
      user_domain_name: "{{ openstack.os_domain }}"
      project_domain_name: "{{ openstack.os_domain }}"
    name: "{{ openstack.sshkey_name }}"
    public_key_file: "{{ key_path }}.pub"
  ignore_errors: true
